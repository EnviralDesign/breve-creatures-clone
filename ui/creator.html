<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Breve Creature Creator</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f1418;
      --panel: #182127;
      --panel-2: #121a1f;
      --text: #d9e6dc;
      --muted: #9eb3a5;
      --accent: #7fcf6f;
      --warn: #e8b56f;
      --err: #dc6e6e;
    }

    * {
      box-sizing: border-box;
      font-family: "Consolas", "Fira Code", monospace;
    }

    body {
      margin: 0;
      background: linear-gradient(160deg, #11191d 0%, #0e1419 50%, #152218 100%);
      color: var(--text);
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(320px, 420px) minmax(420px, 1fr);
      gap: 14px;
      height: calc(100vh - 32px);
    }

    .layout.sidebarCollapsed {
      grid-template-columns: minmax(0, 1fr);
    }

    .layout.sidebarCollapsed #creatorSidebar {
      display: none;
    }

    .card {
      background: color-mix(in srgb, var(--panel) 88%, black);
      border: 1px solid #2d3b35;
      border-radius: 10px;
      padding: 12px;
      min-height: 0;
    }

    h1,
    h2 {
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    h1 {
      font-size: 16px;
    }

    h2 {
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      border: 1px solid #304139;
      background: var(--panel-2);
      color: var(--text);
      border-radius: 7px;
      padding: 8px;
      outline: none;
    }

    textarea {
      min-height: 420px;
      resize: none;
      line-height: 1.3;
    }

    #notesInput {
      min-height: 72px;
      max-height: 180px;
      resize: vertical;
    }

    button {
      border: 1px solid #3b5349;
      background: #1c2a24;
      color: var(--text);
      border-radius: 7px;
      padding: 7px 10px;
      cursor: pointer;
    }

    button:hover {
      border-color: #6c946e;
      color: #e8f7e7;
    }

    button.primary {
      border-color: color-mix(in srgb, var(--accent) 65%, #2b4430);
      background: #1f3422;
    }

    .locks {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin: 10px 0;
    }

    .locks label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      white-space: pre-wrap;
    }

    .status.ok {
      color: var(--accent);
    }

    .status.warn {
      color: var(--warn);
    }

    .status.err {
      color: var(--err);
    }

    .tiny {
      font-size: 11px;
      color: var(--muted);
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin: 4px 0 10px;
      line-height: 1.35;
    }

    .section {
      background: color-mix(in srgb, var(--panel-2) 88%, black);
      border: 1px solid #2a3832;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .section h2 {
      margin: 0 0 8px;
    }

    .modeBadge {
      font-size: 12px;
      color: var(--text);
      border: 1px solid #33433b;
      background: #132019;
      border-radius: 6px;
      padding: 6px 8px;
      width: 100%;
    }

    .legend {
      margin: 6px 0 10px;
      padding-left: 16px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .legend code {
      color: var(--text);
    }

    .rightCard {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .modeRow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .modeButtons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .modeButtons button.active {
      border-color: color-mix(in srgb, var(--accent) 65%, #2b4430);
      background: #1f3422;
      color: #e8f7e7;
    }

    .editorPane {
      display: none;
      min-height: 0;
      flex: 1;
    }

    .editorPane.active {
      display: flex;
      flex-direction: column;
    }

    #visualPane {
      gap: 8px;
    }

    #visualWorkspace {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(220px, 300px) minmax(360px, 1fr) minmax(260px, 340px);
      gap: 10px;
    }

    #visualViewport {
      min-height: 0;
      border: 1px solid #2a3832;
      border-radius: 8px;
      overflow: hidden;
      background: radial-gradient(circle at 15% 20%, #182427, #0f171d 58%, #0c1217 100%);
      position: relative;
    }

    .visualPanel {
      border: 1px solid #2a3832;
      border-radius: 8px;
      background: color-mix(in srgb, var(--panel-2) 88%, black);
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 8px;
      gap: 8px;
    }

    .inspectorPanel {
      min-height: 0;
      flex: 1;
    }

    .visualPanel h2 {
      margin: 0;
      font-size: 12px;
    }

    .visualPanelHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    #outlinerSearch {
      padding: 6px 7px;
      font-size: 12px;
    }

    #outlinerList {
      min-height: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding-right: 2px;
    }

    .outlinerSectionTitle {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      border-top: 1px solid #26332d;
      padding-top: 7px;
      margin-top: 3px;
    }

    .outlinerSectionTitle:first-child {
      border-top: none;
      margin-top: 0;
      padding-top: 0;
    }

    .outlinerItem {
      border: 1px solid #2a3932;
      border-radius: 6px;
      background: #121b1f;
      color: var(--text);
      padding: 5px 7px;
      text-align: left;
      font-size: 12px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .outlinerItem .line1 {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .outlinerItem .line2 {
      color: var(--muted);
      font-size: 11px;
    }

    .outlinerItem.selected {
      border-color: #7fcf6f;
      background: #1b2c22;
      color: #f0f7ea;
    }

    .outlinerItem.node {
      border-left: 3px solid #93c87f;
    }

    .outlinerItem.part {
      border-left: 3px solid #85b2d4;
    }

    .outlinerItem.joint {
      border-left: 3px solid #d2b47f;
    }

    .emptyState {
      color: var(--muted);
      font-size: 12px;
      padding: 6px 2px;
      line-height: 1.35;
    }

    #selectionToolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #selectionBreadcrumb {
      color: var(--muted);
      font-size: 11px;
      white-space: pre-wrap;
      line-height: 1.35;
    }

    #inspectorContent {
      flex: 1;
      min-height: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding-right: 2px;
    }

    .fieldRow,
    .inspectorFieldRow {
      display: grid;
      grid-template-columns: minmax(96px, 130px) 1fr;
      gap: 8px;
      font-size: 12px;
      border-bottom: 1px dotted #25332c;
      padding: 4px 0 6px;
      align-items: start;
    }

    .fieldRow .k,
    .inspectorFieldLabel {
      color: var(--muted);
      line-height: 1.25;
      padding-top: 6px;
    }

    .fieldRow .v,
    .inspectorFieldValue {
      color: var(--text);
      word-break: break-word;
      line-height: 1.35;
      min-width: 0;
    }

    .inspectorFieldControl {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    #inspectorContent input[type="text"],
    #inspectorContent input[type="number"],
    #inspectorContent textarea,
    #inspectorContent select {
      width: 100%;
      border: 1px solid #304139;
      background: #111a1f;
      color: var(--text);
      border-radius: 6px;
      padding: 6px 7px;
      outline: none;
      font-size: 12px;
      line-height: 1.3;
    }

    #inspectorContent input[type="text"]:focus,
    #inspectorContent input[type="number"]:focus,
    #inspectorContent textarea:focus,
    #inspectorContent select:focus {
      border-color: #6c946e;
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--accent) 40%, transparent);
    }

    #inspectorContent input[type="text"]:disabled,
    #inspectorContent input[type="number"]:disabled,
    #inspectorContent textarea:disabled,
    #inspectorContent select:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    #inspectorContent textarea {
      min-height: 54px;
      max-height: 180px;
      resize: vertical;
    }

    .inspectorCheckboxRow {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      font-size: 12px;
      line-height: 1.25;
    }

    .inspectorCheckboxRow input[type="checkbox"] {
      margin: 0;
      accent-color: var(--accent);
    }

    .inspectorFieldHint {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.3;
    }

    .inspectorFieldError {
      font-size: 11px;
      color: var(--err);
      line-height: 1.3;
    }

    .inspectorFieldError:empty {
      display: none;
    }

    .inspectorFieldRow.invalid input[type="text"],
    .inspectorFieldRow.invalid input[type="number"],
    .inspectorFieldRow.invalid textarea,
    .inspectorFieldRow.invalid select {
      border-color: #b35d5d;
    }

    .inspectorFooter {
      border-top: 1px solid #26342d;
      margin-top: 6px;
      padding-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 0 0 auto;
    }

    .inspectorPanelError {
      font-size: 11px;
      color: var(--err);
      line-height: 1.3;
      min-height: 1.2em;
    }

    .inspectorPanelError:empty {
      display: none;
    }

    .inspectorApplyStatus {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.3;
      min-height: 1.2em;
    }

    .inspectorApplyStatus.ok {
      color: var(--accent);
    }

    .inspectorApplyStatus.warn {
      color: var(--warn);
    }

    .inspectorApplyStatus.err {
      color: var(--err);
    }

    #visualInfo {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
      white-space: pre-wrap;
    }

    #jsonPane h2 {
      margin: 0 0 8px;
    }

    #genomeEditor {
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 1020px) {
      body {
        height: auto;
        overflow: auto;
      }

      .layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      #visualWorkspace {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div id="layoutRoot" class="layout">
    <div id="creatorSidebar" class="card" style="overflow-y:auto;">
      <h1>Creature Authoring (V1 MVP)</h1>

      <div class="section">
        <h2>1) Source genome</h2>
        <div class="row">
          <button id="loadCurrentBtn" type="button">Load current genome</button>
          <button id="loadBestBtn" type="button">Load best genome</button>
        </div>
        <div class="row">
          <select id="creatureList"></select>
        </div>
        <div class="row">
          <button id="refreshCreaturesBtn" type="button">Refresh saved list</button>
          <button id="loadSelectedBtn" type="button">Load saved creature</button>
        </div>
      </div>

      <div class="section">
        <h2>2) Creature definition</h2>
        <div class="row">
          <input id="creatureIdInput" type="text" placeholder="creature id (example: hopper_v1)">
        </div>
        <div class="row">
          <textarea id="notesInput" placeholder="optional notes"></textarea>
        </div>
      </div>

      <div class="section">
        <h2>3) Lock profile (authored mode only)</h2>
        <div class="note">
          Checked means fixed by template. Unchecked means evolvable.
        </div>
        <div class="row">
          <button id="presetGaitOnlyBtn" type="button">Preset: gait/controller-only</button>
          <button id="presetGaitAndLimitsBtn" type="button">Preset: gait + joint limits</button>
        </div>
        <ul class="legend">
          <li><code>Body graph</code>: number of parts + how they connect.</li>
          <li><code>Joint kind</code>: hinge vs ball choice per joint.</li>
          <li><code>Joint limits</code>: allowed rotation ranges per joint.</li>
          <li><code>Body shape + joint layout</code>: part sizes/mass, anchor placement, growth direction, edge scaling, max parts.</li>
          <li><code>Actuator mechanics</code>: motor strength and joint stiffness (how much force joints can apply).</li>
          <li><code>Neural policy</code>: brain neurons/weights/effectors (the gait/control policy).</li>
          <li><code>Color</code>: visual hue only.</li>
        </ul>
        <div class="locks">
          <label><input id="lockTopology" type="checkbox"> lock body graph</label>
          <label><input id="lockJointTypes" type="checkbox"> lock joint kind (hinge/ball)</label>
          <label><input id="lockJointLimits" type="checkbox"> lock joint limits</label>
          <label><input id="lockSegmentDynamics" type="checkbox"> lock body shape + joint layout</label>
          <label><input id="lockActuatorMechanics" type="checkbox"> lock actuator mechanics</label>
          <label><input id="lockControls" type="checkbox"> lock neural policy</label>
          <label><input id="lockVisualHue" type="checkbox"> lock color</label>
        </div>
      </div>

      <div class="section">
        <h2>4) Save + apply</h2>
        <div class="note">
          Save writes a creature file. Mode buttons switch backend mode and restart evolution.
        </div>
        <div class="row">
          <button id="saveCreatureBtn" type="button" class="primary">Save creature file</button>
        </div>
        <div class="row">
          <div id="modeStatus" class="modeBadge">Current backend mode: unknown</div>
        </div>
        <div class="row">
          <button id="activateAuthoredBtn" type="button" class="primary">Set mode: authored + restart</button>
        </div>
        <div class="row">
          <button id="setRandomBtn" type="button">Set mode: random + restart</button>
        </div>
      </div>
      <div id="status" class="status">Ready.</div>
      <div class="tiny">Launch directly with: <code>cargo run --release -- --creature your_id</code></div>
    </div>
    <div class="card rightCard">
      <div class="modeRow">
        <h2>Editor</h2>
        <div class="modeButtons">
          <button id="toggleSidebarBtn" type="button">Hide controls</button>
          <button id="showVisualBtn" type="button" class="active">Visual</button>
          <button id="showJsonBtn" type="button">JSON</button>
          <button id="rebuildVisualBtn" type="button">Rebuild visual from JSON</button>
        </div>
      </div>
      <div id="visualPane" class="editorPane active">
        <div id="visualWorkspace">
          <div class="visualPanel">
            <div class="visualPanelHeader">
              <h2>Outliner</h2>
            </div>
            <input id="outlinerSearch" type="text" placeholder="filter (node, part, joint)">
            <div id="outlinerList"></div>
          </div>
          <div id="visualViewport"></div>
          <div class="visualPanel inspectorPanel">
            <div id="selectionToolbar">
              <h2>Inspector</h2>
              <button id="focusSelectedBtn" type="button">Frame selected</button>
            </div>
            <div id="selectionBreadcrumb">Nothing selected.</div>
            <div id="inspectorContent"></div>
            <div id="inspectorFooter" class="inspectorFooter">
              <div id="inspectorPanelError" class="inspectorPanelError" aria-live="polite"></div>
              <div id="inspectorApplyStatus" class="inspectorApplyStatus" aria-live="polite">Inspector ready.</div>
            </div>
          </div>
        </div>
        <div id="visualInfo">Visual mode ready. Load a genome and click "Rebuild visual from JSON" after edits.</div>
      </div>
      <div id="jsonPane" class="editorPane">
        <h2>Genome JSON</h2>
        <textarea id="genomeEditor" spellcheck="false"></textarea>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.1/examples/jsm/"
      }
    }
  </script>

  <script type="module" src="./creator-app.js"></script>
</body>

</html>

